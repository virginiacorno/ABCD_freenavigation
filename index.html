<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity Web Player | ABCD_unity</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
  </head>
  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width=960 height=600 tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"> </div>
      <div id="unity-footer">
        <div id="unity-logo-title-footer"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">ABCD_unity</div>
      </div>
    </div>

    <script>
    /* Early shim: provides SendDataToJS before Unity module loads.
       Once the .jslib plugin (UnityDataBridge) is active inside the
       Emscripten module it will handle calls natively; this shim
       covers the window between page-load and module-ready. */
    (function(){
      if (typeof window.SendDataToJS !== 'undefined') {
        console.log('[Shim] SendDataToJS already present');
        return;
      }
      window.SendDataToJS = function(payload) {
        try {
          var s = typeof payload === 'string' ? payload : JSON.stringify(payload);
          console.log('[WEBGL_DATA] ' + s);
          try {
            var obj = JSON.parse(s);
            window.parent.postMessage({ type: 'UNITY_DATA', data: obj }, '*');
          } catch (e) {
            window.parent.postMessage({ type: 'UNITY_DATA', data: s }, '*');
          }
        } catch (e) {
          console.error('[Shim] SendDataToJS error', e);
        }
      };
      console.log('[Shim] SendDataToJS installed');
    })();
    </script>

    <script>
      var canvas = document.querySelector("#unity-canvas");
      var unityInstance = null; // globally accessible for postMessage handler

      function unityShowBanner(msg, type) {
        var warningBanner = document.querySelector("#unity-warning");
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == 'error') div.style = 'background: red; padding: 10px;';
        else {
          if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
          setTimeout(function() {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/ABCD_git.loader.js";
      var config = {
        arguments: [],
        dataUrl: buildUrl + "/ABCD_git.data",
        frameworkUrl: buildUrl + "/ABCD_git.framework.js",
        codeUrl: buildUrl + "/ABCD_git.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "ABCD_unity",
        productVersion: "0.1.0",
        showBanner: unityShowBanner,
      };

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);
        document.querySelector("#unity-container").className = "unity-mobile";
        canvas.className = "unity-mobile";
      } else {
        canvas.style.width = "960px";
        canvas.style.height = "600px";
      }

      document.querySelector("#unity-loading-bar").style.display = "block";

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
        }).then((instance) => {
          unityInstance = instance;
          console.log('[Unity] Instance ready');

          document.querySelector("#unity-loading-bar").style.display = "none";
          document.querySelector("#unity-fullscreen-button").onclick = () => {
            instance.SetFullscreen(1);
          };
        }).catch((message) => {
          alert(message);
        });
      };

      /* === PostMessage handler: receive participant info from Pavlovia parent === */
      window.addEventListener('message', function(event) {
        console.log('[Unity iframe] Received message:', event.data);

        if (event.data && event.data.type === 'SET_PARTICIPANT') {
          var payload = event.data.payload;
          console.log('[Unity iframe] Setting participant info:', payload);

          var trySetInfo = function() {
            if (unityInstance) {
              try {
                unityInstance.SendMessage('DataLogger', 'SetParticipantInfo', payload);
                console.log('[Unity iframe] Successfully sent participant info to Unity');
              } catch (e) {
                console.error('[Unity iframe] Failed to send to Unity:', e);
              }
            } else {
              console.log('[Unity iframe] Unity not ready, retrying in 500ms...');
              setTimeout(trySetInfo, 500);
            }
          };
          trySetInfo();
        }
      });

      /* === Console-log interceptor: forward completion + data events to parent === */
      (function(){
        var targetOrigin = '*';
        var originalLog = console.log.bind(console);
        var doneSent = false;

        console.log = function() {
          var args = Array.prototype.slice.call(arguments);
          try {
            originalLog.apply(console, args);

            if (doneSent) return;

            var text = args.map(function(a) {
              return typeof a === 'object' ? JSON.stringify(a) : String(a);
            }).join(' ');

            // Detect task completion
            if (text.indexOf('All configurations completed!') !== -1 ||
                text.indexOf('FinishAllConfigurations: all configs completed.') !== -1 ||
                text.indexOf('ABCD_DONE') !== -1) {
              doneSent = true;
              try { window.parent.postMessage('ABCD_DONE', targetOrigin); } catch (e) {}
              originalLog('[postMessage bridge] ABCD_DONE sent to parent.');
            }

            // Forward WEBGL_DATA logs to parent
            if (text.indexOf('[WEBGL_DATA]') !== -1) {
              try {
                var jsonStart = text.indexOf('{');
                if (jsonStart !== -1) {
                  var jsonStr = text.substring(jsonStart);
                  var data = JSON.parse(jsonStr);
                  window.parent.postMessage({ type: 'UNITY_DATA', data: data }, targetOrigin);
                  originalLog('[Unity -> Parent] Sent data event:', data.event_type);
                }
              } catch (e) {
                originalLog('[Unity -> Parent] Failed to parse/send data:', e);
              }
            }
          } catch (e) {
            try { originalLog('console wrapper error', e); } catch (_) {}
          }
        };
      })();

      document.body.appendChild(script);
    </script>
  </body>
</html>
